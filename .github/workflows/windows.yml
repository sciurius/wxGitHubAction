name: wxPerl build for Microsoft Windows

on: push

# Environment variables.
env:

  # Version of wxWidgets to install
  WX:     3.2.9
  WXDIR:  C:\wxWidgets-3.2.9

  # Strawberry Perl version
  PERL:   "5.42.0"
  PERLDL: perl542
  PV:     C:/hostedtoolcache/windows/strawberry-perl/5.42.0/x64/perl/site/lib

  # Alien::wxWidgets and wxPerl
  AWV:    0.73
  WXV:    3.009

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Perl
        uses: shogo82148/actions-setup-perl@v1
        with:
          distribution: strawberry
          perl-version: "${{ env.PERL }}"
      - run: perl -V
      - run: gcc --version
      - run: cpanm ExtUtils::XSpp
      - run: cpanm Net::SSLeay --notest

      - name: Add wxWidgets (Source)
        run: |
          mkdir ${{ env.WXDIR }}
          Invoke-WebRequest -Uri "https://github.com/wxWidgets/wxWidgets/releases/download/v${{ env.WX }}/wxWidgets-${{ env.WX }}.7z" -OutFile "wxWidgets.7z"
          7z x -o${{ env.WXDIR }} wxWidgets.7z

      - name: Build wxWidgets
        run: |
          cd ${{ env.WXDIR }}/build/msw
          gmake -f makefile.gcc SHELL=cmd.exe BUILD=release SHARED=1 setup_h
          gmake -f makefile.gcc -j2 SHELL=cmd.exe BUILD=release SHARED=1

      - name: Add wxWidgets (PATH)
        run: |
          echo "${{ env.WXDIR }}\lib\gcc_dll" | Out-File -FilePath $Env:GITHUB_PATH -Encoding utf8 -Append
        
      - name: Add Alien::wxWidgets
        run: |
          Invoke-WebRequest -Uri "https://github.com/sciurius/perl-Alien-wxWidgets/releases/download/R${{ env.AWV }}/Alien-wxWidgets-${{ env.AWV }}.tar.gz" -OutFile "AWV.tar.gz"
          tar xf AWV.tar.gz
          cd Alien-wxWidgets-${{ env.AWV }}
          mkdir ${{ env.PV }}/Alien/wxWidgets/Config
          copy lib/Alien/wxWidgets.pm ${{ env.PV }}/Alien
          copy lib/Alien/wxWidgets/Utility.pm ${{ env.PV }}/Alien/wxWidgets
          perl script/make_cfg.pl "--wxdir=${{ env.WXDIR }}" "--output=%{sitelib}/%{alien_config}"
          cd ..
          rm -Recurse -Force Alien-wxWidgets-${{ env.AWV }}
          perl -MAlien::wxWidgets -E "say Alien::wxWidgets->prefix"

      - name: Add wxPerl
        run: |
          Invoke-WebRequest -Uri "https://github.com/sciurius/wxPerl/releases/download/R${{ env.WXV }}/Wx-${{ env.WXV }}.tar.gz" -OutFile "wxPerl.tar.gz"
          tar xf wxPerl.tar.gz
          cd Wx-${{ env.WXV }}
          perl Makefile.PL
          gmake
          perl -Mblib -MWx -E 'say $Wx::VERSION'
          gmake install
          cd ..
          rm -Recurse -Force Wx-${{ env.WXV }}

      - name: Test wxPerl
        run: |
          echo $Env:PATH
          perl -MWx -E 'say join(q{ },$Wx::VERSION,$Wx::wxVERSION)'

 
